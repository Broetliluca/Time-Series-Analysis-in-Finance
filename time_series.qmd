---
title: "Time Series Analysis in Finance"
subtitle: "How do changes in EU ETS carbon allowance prices affect the returns of sustainable ETFs compared to carbon-intensive ETFs"
author:
  - name: "Luca Signorini"
  - name: "Mattia Bettoja"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
format:
  html:
    theme: journal
    toc: true
    toc-depth: 3
    toc-floating: true
    df-print: paged
execute:
  echo: true
  warning: false
  message: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(readr)
library(lubridate)
library(zoo)
library(tseries)
library(vars)
library(rugarch)
library(corrplot)
library(lmtest)
```

# 1. Introduction

This project investigates how **EU ETS carbon allowance prices** influence the performance of two ETFs:

- **Sustainable ETF:** iShares MSCI Europe *Paris-Aligned Climate*  
  → expected to be less exposed to rising carbon prices  

- **Carbon-intensive ETF:** iShares STOXX Europe 600 *Oil & Gas*  
  → expected to react negatively to rising carbon prices  

The goal is to compare **returns, relationships, and volatility patterns** across these series.

(Add sources EU ETS explanation, carbon pricing mechanics, ETF methodology.)

# 2. Background 

## 2.1 EU ETS Carbon Prices
EU ETS allowances represent the right to emit one tonne of CO₂. Prices fluctuate based on supply, policy changes, and industrial demand.  
(*Source.*)

## 2.2 Paris-Aligned Climate ETF
Tracks companies aligned with the Paris climate transition pathway. Expected to be less carbon-sensitive.  
(*Source*)

## 2.3 Oil & Gas ETF
Tracks fossil-fuel-intensive companies whose profitability depends heavily on carbon exposure.  
(*Source to add later.*)

# 3. Method Overview 

We apply fundamental time series steps:

1. **Import data**
2. **Clean & merge datasets**
3. **Compute log-returns**
4. **Exploratory data analysis (EDA)**
5. **Prepare for later modeling (VAR, Granger, GARCH)**
6.

# 4. Data Loading & Preprocessing

## 4.1 Load datasets from GitHub

```{r load}
library(tidyverse)
library(readr)
library(lubridate)

base <- "https://raw.githubusercontent.com/Broetliluca/Time-Series-Analysis-in-Finance/main/.csv%20Data/"

url_eua <- paste0(base, "icap-graph-price-data-2019-01-07-2025-11-20.csv")
url_pa  <- paste0(base, "iShares-MSCI-Europe-Paris-Aligned-Climate-UCITS-ETF-EUR-Acc_fund.csv")
url_oil <- paste0(base, "STOXX-Europe-600-Oil--Gas-UCITS-ETF-DE_fund.csv")

eua_raw  <- read_csv(url_eua, show_col_types = FALSE)
pa_raw   <- read_csv(url_pa,  show_col_types = FALSE)
oil_raw  <- read_csv(url_oil, show_col_types = FALSE)
```

---

## 4.2 Clean EUA carbon price data

Structure confirmed:

- First row = metadata  
- Columns: `Date_raw`, `Primary`, `Secondary`, others  

```{r clean_eua}
# Ensure tibble format
eua_raw <- as_tibble(eua_raw)

# Remove first descriptive row safely
eua_tmp <- eua_raw %>% slice(-1)

# Clean EUA data
eua_clean <- eua_tmp %>%
  rename(
    Date_raw  = `...1`,
    Primary   = `...5`,
    Secondary = `...6`
  ) %>%
  mutate(
    Date      = as.Date(Date_raw),
    Primary   = suppressWarnings(parse_number(Primary)),
    Secondary = suppressWarnings(parse_number(Secondary)),
    EUA_Price = if_else(!is.na(Primary), Primary, Secondary)
  ) %>%
  dplyr::select(Date, EUA_Price) %>%
  arrange(Date)

head(eua_clean)

```

---

## 4.3 Clean Paris-Aligned ETF data 

This dataset is *semicolon-separated inside a single column*.

```{r clean_pa}
# Ensure PA data is a tibble
pa_raw <- as_tibble(pa_raw)

# Split the single-column format
pa_tmp <- pa_raw %>%
  separate(
    col = 1,
    into = c("Date_raw","Currency","NAV","Shares","Assets","FundRet","BenchRet"),
    sep = ";",
    fill = "right",
    extra = "merge"
  )

# Clean
pa_clean <- pa_tmp %>%
  mutate(
    Date_raw = str_replace(Date_raw, "\\.", "/"),
    Date     = suppressWarnings(dmy(Date_raw)),
    NAV      = suppressWarnings(parse_number(NAV))
  ) %>%
  dplyr::select(Date, PA_NAV = NAV) %>%
  filter(!is.na(Date)) %>%
  arrange(Date)

head(pa_clean)
```

---

## 4.4 Clean Oil & Gas ETF data

Same semicolon-separated structure.

```{r clean_oil}
# Ensure tibble
oil_raw <- as_tibble(oil_raw)

# Split single-column format
oil_tmp <- oil_raw %>%
  tidyr::separate(
    col  = 1,
    into = c("Date_raw","Currency","NAV","Shares","Assets","FundRet","BenchRet"),
    sep  = ";",
    fill = "right",
    extra = "merge"
  )

# Clean OIL ETF data
oil_clean_full <- oil_tmp %>%
  dplyr::mutate(
    # 20.Nov.2025 -> 20/Nov/2025 so dmy() can parse it
    Date_str = stringr::str_replace(Date_raw, "\\.", "/"),
    Date     = suppressWarnings(lubridate::dmy(Date_str)),
    NAV_num  = suppressWarnings(readr::parse_number(NAV))
  ) %>%
  dplyr::arrange(Date)

# Keep only Date + NAV
oil_clean <- oil_clean_full[, c("Date", "NAV_num")]
names(oil_clean)[2] <- "OIL_NAV"

head(oil_clean)
```

---

## 4.5 Align overlapping date range & merge datasets

```{r merge}
start_date <- max(
  min(eua_clean$Date, na.rm = TRUE),
  min(pa_clean$Date,  na.rm = TRUE),
  min(oil_clean$Date, na.rm = TRUE)
)

end_date <- min(
  max(eua_clean$Date, na.rm = TRUE),
  max(pa_clean$Date,  na.rm = TRUE),
  max(oil_clean$Date, na.rm = TRUE)
)

# Filter each series to the common window
eua_f <- eua_clean %>% dplyr::filter(Date >= start_date, Date <= end_date)
pa_f  <- pa_clean  %>% dplyr::filter(Date >= start_date, Date <= end_date)
oil_f <- oil_clean %>% dplyr::filter(Date >= start_date, Date <= end_date)

# Merge step by step
merged <- eua_f %>%
  dplyr::inner_join(pa_f,  by = "Date") %>%
  dplyr::inner_join(oil_f, by = "Date") %>%
  dplyr::arrange(Date)

head(merged)
```

---

## 4.6 Compute log-returns

```{r returns}
returns <- merged %>%
  dplyr::mutate(
    EUA_ret = log(EUA_Price / dplyr::lag(EUA_Price)),
    PA_ret  = log(PA_NAV    / dplyr::lag(PA_NAV)),
    OIL_ret = log(OIL_NAV   / dplyr::lag(OIL_NAV))
  ) %>%
  tidyr::drop_na()

head(returns)
```

---

# 5. Exploratory Data Analysis (EDA)

## 5.1 Summary statistics

```{r stats}


```

---

## 5.2 Time series plot of returns

```{r plot_returns}

```

---

## 5.3 Rolling 30-day volatility

```{r rolling}

```

---

## 5.4 Correlation matrix

```{r corrmatrix}

```

---
